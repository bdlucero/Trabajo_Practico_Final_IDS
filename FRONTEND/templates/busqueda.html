{% extends 'base.html' %}

{% block contenido %}
    
  <section class="hero">
    <div class="container">
      <h1><span class="mark">Busc√°</span> materiales</h1>
      {% if user %}
        <p class="lead">Bienvenido, {{ user.nombre }} ‚Äî busc√° apuntes, parciales y m√°s.</p>
      {% else %}
        <p class="lead">Apuntes, parciales resueltos, enlaces y m√°s. Filtr√° por materias, tipo y formato.</p>
      {% endif %}

      <form id="searchForm"
            class="searchbar"
            role="search"
            method="get"
            action="{{ url_for('buscar') }}">
        <div class="input-wrap">
          <input id="q"
                 name="q"
                 type="search"
                 placeholder="Ej: parcial an√°lisis | apunte √°lgebra | final algoritmos"
                 aria-label="Buscar"
                 autocomplete="off"
                 value="{{ q or '' }}">
        </div>
        <button type="submit" class="btn btn-primary">Buscar</button>
      </form>
    </div>
  </section>

  <main id="app" class="container layout">
    <!-- FILTROS -->
    <aside class="filters" aria-label="Filtros">
      <form id="filtersForm" method="get" action="{{ url_for('buscar') }}">
        <input type="hidden" name="q" id="qHidden" value="{{ q or '' }}">
        <input type="hidden" name="sort" id="sortHidden" value="{{ sort or '-fecha' }}">
        <input type="hidden" name="page" value="{{ page or 1 }}">
        <input type="hidden" name="page_size" value="{{ page_size or 12 }}">

        <fieldset>
          <legend>
            Materias
            <small class="muted materias-counter" aria-live="polite"></small>
          </legend>

          <div class="input-with-icon">
            <input id="materiaFilter"
                   type="text"
                   placeholder="Filtrar materias‚Ä¶"
                   autocomplete="off">
            <span class="icon">üîé</span>
          </div>

          <div id="materiasList"
               class="checklist"
               role="group"
               aria-label="Materias">
            {% for m in materias %}
              <label class="materia-item"
                     data-name="{{ m.nombre
                       | lower
                       | replace('√°','a')
                       | replace('√©','e')
                       | replace('√≠','i')
                       | replace('√≥','o')
                       | replace('√∫','u')
                       | replace('√º','u') }}">
                <input class="ck"
                       type="checkbox"
                       name="materias"
                       value="{{ m.codigo }}"
                       {% if materias_seleccionadas and m.codigo in materias_seleccionadas %}checked{% endif %}>
                <span class="ckbox"></span>
                <span class="cklabel">{{ m.nombre }}</span>
              </label>
            {% endfor %}
          </div>

          <div class="filter-actions">
            <button type="button" class="btn btn-ghost" data-action="all">Seleccionar todo</button>
            <button type="button" class="btn btn-ghost" data-action="none">Limpiar</button>
          </div>
        </fieldset>

        <fieldset>
          <legend>Formato</legend>
          <div id="formatoList" class="checklist tiny">
            {% set formatos_def = [
              ('pdf', 'PDF'),
              ('imagen', 'Imagen'),
              ('carpeta comprimida', 'Carpeta comprimida'),
              ('repositorio', 'Repositorio')
            ] %}
            {% for value, label in formatos_def %}
              <label class="formato-item">
                <input class="ck"
                       type="checkbox"
                       name="formato"
                       value="{{ value }}"
                       {% if formatos_seleccionados and value in formatos_seleccionados %}checked{% endif %}>
                <span class="ckbox"></span>
                <span class="cklabel">{{ label }}</span>
              </label>
            {% endfor %}
          </div>
        </fieldset>

        <div class="filter-footer">
          <button type="submit" class="btn btn-primary">Aplicar filtros</button>
          <button type="button" id="clearFilters" class="btn btn-ghost">Limpiar filtros</button>
        </div>
      </form>
    </aside>

    <!-- RESULTADOS -->
    <section class="results">
      <div class="results-bar">
        <div id="resultsCount" aria-live="polite">
          {% if error %}
            {{ error }}
          {% elif total %}
            {{ total }} resultado{% if total != 1 %}s{% endif %}
          {% else %}
            Sin resultados
          {% endif %}
        </div>

        <div class="bar-actions">
          <label class="select">
            <span>Ordenar</span>
            <select id="sort">
              <option value="-fecha" {% if sort == '-fecha' or not sort %}selected{% endif %}>
                M√°s nuevos
              </option>
              <option value="-comentarios" {% if sort == '-comentarios' %}selected{% endif %}>
                M√°s comentados
              </option>
            </select>
          </label>
        </div>
      </div>

      <div id="chips" class="chips" aria-live="polite"></div>

      <section id="empty" class="empty-state" {% if total %}hidden{% endif %}>
        <div class="holo">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <h2>Empez√° una b√∫squeda</h2>
        <p>Us√° la barra y los filtros para ver publicaciones. Cuando haya resultados, van a aparecer ac√°.</p>
      </section>

      <!--  RESULTADOS -->
      <ul id="grid" class="cards" {% if not total %}hidden{% endif %}>
        {% for p in resultados %}
          {% set url = p.url or '#' %}
          <li class="card" id="pub-{{ p.id }}">
            <h3>
              <a href="{{ url }}" target="_blank" rel="noopener">
                {{ p.titulo or "Sin t√≠tulo" }}
              </a>
            </h3>

            <div class="meta">
              <span>Por {{ p.autor_nombre or "An√≥nimo" }}</span>
              {% if p.creado_en %} ‚Ä¢ <span>{{ p.creado_en }}</span>{% endif %}
              {% if p.formato %}<span class="badge">{{ p.formato }}</span>{% endif %}
            </div>

            {% if p.materias %}
              <div class="tags">
                {% for m in p.materias %}
                  <span class="badge">{{ m.nombre }}</span>
                {% endfor %}
              </div>
            {% endif %}

            {% if p.descripcion %}
              <p class="desc">{{ p.descripcion }}</p>
            {% endif %}

            <div class="actions">
              {% if p.url %}
                <a class="btn btn-primary" href="{{ url }}" target="_blank" rel="noopener">
                  {% if p.formato in ['pdf', 'imagen'] %}
                    Ver / previsualizar
                  {% else %}
                    Abrir enlace
                  {% endif %}
                </a>
              {% endif %}

              {% if p.es_archivo_subido %}
                    <a class="btn btn-ghost"
                      href="{{ url_for('descargar_archivo', file_url=p.url) }}">
                      Descargar
                    </a>
                  {% endif %}


              {% if p.autor_email %}
                {% set mail = p.autor_email %}
                {% set subject = "Consulta sobre tu publicaci√≥n en SkillMatch UBA" | urlencode %}
                {% set body = (
                  "Hola, te contacto desde SkillMatch UBA por tu publicaci√≥n '" ~ (p.titulo or '') ~ "'."
                ) | urlencode %}
                <a class="btn btn-ghost"
                   href="mailto:{{ mail }}?subject={{ subject }}&body={{ body }}">
                  Contactar autor
                </a>
              {% endif %}

              <button type="button"
                      class="btn btn-ghost btn-toggle-reviews"
                      data-target="panel-resenas-{{ p.id }}">
                Ver rese√±as
              </button>
            </div>

            {# RESE√ëAS DENTRO DE LA CARD #}
            <div class="reviews-section" id="panel-resenas-{{ p.id }}" hidden>
              <div class="reviews-content">

                <ul class="reviews-list">
                  {% if p.resenas %}
                    {% for r in p.resenas %}
                      <li class="review-item">
                        <div class="reviews-head">
                          {% set cal = r.calificacion or 0 %}
                          {% set estrellas = '‚òÖ' * cal + '‚òÜ' * (5 - cal) %}
                          <span class="stars">{{ estrellas }}</span>
                          {% if r.fecha_resena %}
                            <span class="rese√±a-fecha">{{ r.fecha_resena }}</span>
                          {% endif %}
                        </div>
                        {% if r.comentario %}
                          <p>{{ r.comentario }}</p>
                        {% endif %}
                      </li>
                    {% endfor %}
                  {% else %}
                    <li class="review-item">
                      <p class="muted">Esta publicaci√≥n todav√≠a no tiene rese√±as.</p>
                    </li>
                  {% endif %}
                </ul>

                <form class="review-form"
                      method="post"
                      action="{{ url_for('buscar') }}#pub-{{ p.id }}">
                  <input type="hidden" name="pub_id" value="{{ p.id }}">
                  <input type="hidden" name="q" value="{{ q or '' }}">
                  <input type="hidden" name="sort" value="{{ sort or '-fecha' }}">
                  <input type="hidden" name="page" value="{{ page or 1 }}">
                  <input type="hidden" name="page_size" value="{{ page_size or 12 }}">

                  {% for cod in materias_seleccionadas %}
                    <input type="hidden" name="materias" value="{{ cod }}">
                  {% endfor %}
                  {% for f in formatos_seleccionados %}
                    <input type="hidden" name="formato" value="{{ f }}">
                  {% endfor %}

                  <textarea name="comentario" rows="3"
                            placeholder="Escrib√≠ tu rese√±a..."></textarea>

                  <div class="rating-row">
                    <label for="calificacion-{{ p.id }}">Calificaci√≥n</label>
                    <select id="calificacion-{{ p.id }}" name="calificacion">
                      <option value="5">5 ‚òÖ</option>
                      <option value="4">4 ‚òÖ</option>
                      <option value="3">3 ‚òÖ</option>
                      <option value="2">2 ‚òÖ</option>
                      <option value="1">1 ‚òÖ</option>
                    </select>
                    <button type="submit" class="btn btn-primary">Enviar rese√±a</button>
                  </div>
                </form>

              </div>
            </div>

          </li>
        {% endfor %}
      </ul>

      <nav id="pagination"
           class="pagination"
           aria-label="Paginaci√≥n"
           {% if pages <= 1 %}hidden{% endif %}>
        {% if pages > 1 %}
          {% if page > 1 %}
            <a href="{{ url_for('buscar',
                                q=q,
                                sort=sort,
                                page=page-1,
                                page_size=page_size,
                                materias=materias_seleccionadas,
                                formato=formatos_seleccionados) }}">
              Anterior
            </a>
          {% endif %}

          <span>P√°gina {{ page }} de {{ pages }}</span>

          {% if page < pages %}
            <a href="{{ url_for('buscar',
                                q=q,
                                sort=sort,
                                page=page+1,
                                page_size=page_size,
                                materias=materias_seleccionadas,
                                formato=formatos_seleccionados) }}">
              Siguiente
            </a>
          {% endif %}
        {% endif %}
      </nav>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script defer src="{{ url_for('static', filename='js/busqueda.js') }}"></script>

{% endblock %}
