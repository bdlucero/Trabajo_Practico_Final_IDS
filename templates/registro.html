<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>SkillMatch UBA — Registro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/skillmatch_v2.css') }}">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="{{ url_for('buscar') }}"><span>SkillMatch</span> UBA</a>
      <nav class="nav">
        <a href="{{ url_for('buscar') }}">Buscar</a>
        <a href="{{ url_for('registro') }}">Registro</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container" style="max-width:480px">
      <h1><span class="mark">Registro institucional</span></h1>
      <p class="lead">Solo cuentas @fi.uba.ar. Ingresá tu legajo para continuar.</p>

      {% if error %}
      <p style="color:#ff6666;font-weight:600;">{{ error }}</p>
      {% endif %}

      <form id="registroForm" method="POST" action="{{ url_for('registro') }}" class="card">
        <label for="legajo">Número de legajo</label>
        <input type="text" id="legajo" name="legajo" placeholder="Ej: 12345" required
               style="width:100%;padding:.7rem;border-radius:10px;border:1px solid var(--line);background:var(--glass);color:#fff;margin:.5rem 0 1rem">

        <!-- Google Sign-In -->
        <div id="g_id_onload"
             data-client_id="{{ google_client_id }}"
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-shape="rectangular"
             data-theme="outline"
             data-text="sign_in_with"
             data-size="large"
             data-logo_alignment="left">
        </div>

        <input type="hidden" name="email" id="emailInput">
      </form>

      <p id="msg" style="margin-top:1rem;color:#aab7dc"></p>
    </div>
  </section>

  <script>
    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);
      const email = data.email || "";
      const msg = document.getElementById("msg");
      const legajo = document.getElementById("legajo").value.trim();
      const emailInput = document.getElementById("emailInput");

      if (!legajo) {
        msg.textContent = "Por favor, ingresá tu número de legajo antes de continuar.";
        return;
      }

      if (!email.endsWith("@fi.uba.ar")) {
        msg.textContent = "Solo se permiten correos institucionales (@fi.uba.ar).";
        return;
      }

      msg.textContent = "Verificado correctamente. Bienvenido/a " + email + ".";
      emailInput.value = email;
      document.getElementById("registroForm").submit();
    }

    function parseJwt (token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }
  </script>
</body>
</html>
